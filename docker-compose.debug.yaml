version: '3.8'

services:
  php:
    build:
      context: .
      dockerfile: Dockerfile.debug
    container_name: opa-php-debug
    volumes:
      - ./:/usr/src/opa
      - ./tests:/app/tests
      - ./logs:/app/logs
      - core-dumps:/var/log/core-dumps
    environment:
      - OPA_ENABLED=1
      - OPA_SOCKET_PATH=opa-agent:9090
      - OPA_SAMPLING_RATE=1.0
      - OPA_COLLECT_INTERNAL_FUNCTIONS=1
      - OPA_DEBUG_LOG=1
      - OPA_CURL_CAPTURE_BODY=1
      - OPA_SERVICE=curl-e2e-debug
      - PHP_OPCACHE_ENABLE=0
    networks:
      - opa-network
    depends_on:
      - mysql
    cap_add:
      - SYS_PTRACE  # Required for gdb
    security_opt:
      - seccomp:unconfined  # Required for gdb
    stdin_open: true
    tty: true
    command: tail -f /dev/null  # Keep container running for debugging

  mysql:
    image: mysql:8.0
    container_name: opa-mysql-debug
    environment:
      MYSQL_ROOT_PASSWORD: rootpassword
      MYSQL_DATABASE: testdb
      MYSQL_USER: testuser
      MYSQL_PASSWORD: testpass
    networks:
      - opa-network
    ports:
      - "3307:3306"

volumes:
  core-dumps:

networks:
  opa-network:
    external: true

