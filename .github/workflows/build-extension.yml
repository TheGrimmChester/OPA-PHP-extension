name: Build PHP Extension

on:
  push:
    tags:
      - 'v*'
  pull_request:
    branches: [ main, master, develop ]
  workflow_dispatch:
    inputs:
      php_version:
        description: 'PHP version (8.3, 8.4 or 8.5)'
        required: true
        default: '8.4'
        type: choice
        options:
          - '8.3'
          - '8.4'
          - '8.5'

jobs:
  build-linux:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        php_version: ['8.3', '8.4', '8.5']
        arch: ['linux/amd64', 'linux/arm64/v8']
        include:
          - php_version: '8.3'
            php_package: 'php8.3-dev'
          - php_version: '8.4'
            php_package: 'php8.4-dev'
          - php_version: '8.5'
            php_package: 'php8.5-dev'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Check for code changes
        id: code_changes
        run: |
          # For workflow_dispatch (manual trigger), always build
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "Manual trigger detected. Proceeding with build."
            echo "should_build=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # For tag pushes, always build
          if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            echo "Tag push detected. Proceeding with build."
            echo "should_build=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # For pull requests, check if relevant files changed
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            BASE_SHA="${{ github.event.pull_request.base.sha }}"
            HEAD_SHA="${{ github.event.pull_request.head.sha }}"
            CHANGED_FILES=$(git diff --name-only ${BASE_SHA}..${HEAD_SHA} -- "*.c" "*.h" "*.m4" "*.ac" | wc -l)
          else
            # For push events, check changes in the commit
            if [ -n "${{ github.event.before }}" ] && [ "${{ github.event.before }}" != "0000000000000000000000000000000000000000" ]; then
              CHANGED_FILES=$(git diff --name-only ${{ github.event.before }}..${{ github.event.after }} -- "*.c" "*.h" "*.m4" "*.ac" | wc -l)
            else
              # If no before SHA, check current commit
              CHANGED_FILES=$(git diff-tree --no-commit-id --name-only -r HEAD -- "*.c" "*.h" "*.m4" "*.ac" | wc -l)
            fi
          fi
          
          if [ "$CHANGED_FILES" -gt 0 ]; then
            echo "Relevant files (.c, .h, .m4, or .ac) have changed. Proceeding with build."
            echo "should_build=true" >> $GITHUB_OUTPUT
          else
            echo "No relevant files changed. Skipping build."
            echo "should_build=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Set up QEMU
        if: steps.code_changes.outputs.should_build == 'true'
        uses: docker/setup-qemu-action@v3
      
      - name: Set up Docker Buildx
        if: steps.code_changes.outputs.should_build == 'true'
        uses: docker/setup-buildx-action@v3
      
      - name: Build Docker image for ${{ matrix.arch }}
        if: steps.code_changes.outputs.should_build == 'true'
        uses: docker/build-push-action@v5
        with:
          context: .
          file: docker/Dockerfile
          platforms: ${{ matrix.arch }}
          build-args: |
            PHP_VERSION=${{ matrix.php_version }}
          tags: opa-php-${{ matrix.php_version }}-${{ matrix.arch }}:local
          outputs: type=docker,dest=/tmp/opa-php-${{ matrix.php_version }}-${{ matrix.arch }}.tar
          cache-from: type=gha
          cache-to: type=gha,mode=max
      
      - name: Extract .so file from container
        if: steps.code_changes.outputs.should_build == 'true'
        run: |
          # Load the image
          docker load -i /tmp/opa-php-${{ matrix.php_version }}-${{ matrix.arch }}.tar
          
          # Create architecture-specific directory name
          ARCH_NAME=$(echo "${{ matrix.arch }}" | sed 's|/v8||g' | sed 's|/|-|g' | tr -d ' ')
          
          # Create output directory
          mkdir -p dist/php${{ matrix.php_version }}/$ARCH_NAME
          
          # Create a temporary container and extract the file
          CONTAINER_ID=$(docker create opa-php-${{ matrix.php_version }}-${{ matrix.arch }}:local)
          
          # Copy from build directory
          docker cp $CONTAINER_ID:/usr/src/opa/modules/opa.so dist/php${{ matrix.php_version }}/$ARCH_NAME/opa.so
          
          # Clean up
          docker rm $CONTAINER_ID
      
      - name: Set artifact name
        if: steps.code_changes.outputs.should_build == 'true'
        id: artifact_name
        run: |
          ARCH_SANITIZED=$(echo "${{ matrix.arch }}" | sed 's|/|-|g' | sed 's|-v8||g' | sed 's|v8||g' | sed 's|-*$||' | tr -d ' ')
          echo "name=opa-php${{ matrix.php_version }}-$ARCH_SANITIZED" >> $GITHUB_OUTPUT
      
      - name: Upload artifact
        if: steps.code_changes.outputs.should_build == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.artifact_name.outputs.name }}
          path: dist/php${{ matrix.php_version }}/*
          retention-days: 30
  
  build-macos:
    runs-on: macos-latest
    strategy:
      matrix:
        php_version: ['8.3', '8.4', '8.5']
        arch: ['darwin/amd64', 'darwin/arm64']
        include:
          - php_version: '8.3'
            php_brew: 'php@8.3'
          - php_version: '8.4'
            php_brew: 'php@8.4'
          - php_version: '8.5'
            php_brew: 'php@8.5'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Check for code changes
        id: code_changes
        run: |
          # For workflow_dispatch (manual trigger), always build
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "Manual trigger detected. Proceeding with build."
            echo "should_build=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # For tag pushes, always build
          if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            echo "Tag push detected. Proceeding with build."
            echo "should_build=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # For pull requests, check if relevant files changed
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            BASE_SHA="${{ github.event.pull_request.base.sha }}"
            HEAD_SHA="${{ github.event.pull_request.head.sha }}"
            CHANGED_FILES=$(git diff --name-only ${BASE_SHA}..${HEAD_SHA} -- "*.c" "*.h" "*.m4" "*.ac" | wc -l)
          else
            # For push events, check changes in the commit
            if [ -n "${{ github.event.before }}" ] && [ "${{ github.event.before }}" != "0000000000000000000000000000000000000000" ]; then
              CHANGED_FILES=$(git diff --name-only ${{ github.event.before }}..${{ github.event.after }} -- "*.c" "*.h" "*.m4" "*.ac" | wc -l)
            else
              # If no before SHA, check current commit
              CHANGED_FILES=$(git diff-tree --no-commit-id --name-only -r HEAD -- "*.c" "*.h" "*.m4" "*.ac" | wc -l)
            fi
          fi
          
          if [ "$CHANGED_FILES" -gt 0 ]; then
            echo "Relevant files (.c, .h, .m4, or .ac) have changed. Proceeding with build."
            echo "should_build=true" >> $GITHUB_OUTPUT
          else
            echo "No relevant files changed. Skipping build."
            echo "should_build=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Install PHP and dependencies
        if: steps.code_changes.outputs.should_build == 'true'
        run: |
          brew install ${{ matrix.php_brew }} autoconf libtool pkg-config lz4
          brew link --force --overwrite ${{ matrix.php_brew }}
          echo "$(brew --prefix ${{ matrix.php_brew }})/bin" >> $GITHUB_PATH
      
      - name: Build extension
        if: steps.code_changes.outputs.should_build == 'true'
        run: |
          phpize
          ./configure --enable-opa
          make
      
      - name: Create release directory
        if: steps.code_changes.outputs.should_build == 'true'
        run: |
          ARCH_NAME=$(echo "${{ matrix.arch }}" | sed 's/\//-/g')
          mkdir -p dist/php${{ matrix.php_version }}/$ARCH_NAME
          cp modules/opa.dylib dist/php${{ matrix.php_version }}/$ARCH_NAME/opa.dylib || \
          cp modules/opa.so dist/php${{ matrix.php_version }}/$ARCH_NAME/opa.dylib
      
      - name: Set artifact name
        if: steps.code_changes.outputs.should_build == 'true'
        id: artifact_name
        run: |
          ARCH_SANITIZED=$(echo "${{ matrix.arch }}" | sed 's|/|-|g')
          echo "name=opa-php${{ matrix.php_version }}-$ARCH_SANITIZED" >> $GITHUB_OUTPUT
      
      - name: Upload artifact
        if: steps.code_changes.outputs.should_build == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.artifact_name.outputs.name }}
          path: dist/php${{ matrix.php_version }}/*
          retention-days: 30
  
  release:
    needs: [build-linux, build-macos]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist
          merge-multiple: false
      
      - name: List downloaded artifacts
        run: |
          echo "=== Downloaded artifact directories ==="
          ls -la dist/ || echo "No dist directory"
          echo ""
          echo "=== Artifact directory contents ==="
          for dir in dist/*/; do
            if [ -d "$dir" ]; then
              echo "Directory: $dir"
              find "$dir" -type f | head -5
              echo ""
            fi
          done
      
      - name: Reorganize artifacts
        run: |
          # Reorganize downloaded artifacts into expected structure with descriptive names
          mkdir -p dist/release
          
          # Debug: show structure
          echo "=== Artifact structure ==="
          find dist -type f \( -name "*.so" -o -name "*.dylib" \) | sort || echo "No .so or .dylib files found"
          echo ""
          echo "=== Directory structure ==="
          find dist -type d | sort || echo "No directories found"
          echo ""
          
          # Process each artifact directory
          # Artifacts are downloaded as: dist/{artifact-name}/...
          # Artifact names are: opa-php{version}-{arch}
          # Files inside are: {artifact-name}/php{version}/{arch}/opa.{so,dylib}
          
          for artifact_dir in dist/opa-php*; do
            if [ ! -d "$artifact_dir" ]; then
              continue
            fi
            
            # Extract version and architecture from artifact directory name
            # Example: opa-php8.4-linux-amd64 -> version=8.4, arch=linux-amd64
            ARTIFACT_NAME=$(basename "$artifact_dir")
            
            # Extract PHP version (8.3, 8.4, or 8.5)
            VERSION=$(echo "$ARTIFACT_NAME" | grep -oE 'php(8\.[345])' | sed 's/php//')
            
            # Extract architecture (everything after opa-php{version}-)
            ARCH_NAME=$(echo "$ARTIFACT_NAME" | sed "s/opa-php${VERSION}-//")
            
            if [ -z "$VERSION" ] || [ -z "$ARCH_NAME" ]; then
              echo "Warning: Could not parse artifact name: $ARTIFACT_NAME"
              continue
            fi
            
            echo "Processing artifact: $ARTIFACT_NAME (PHP $VERSION, arch: $ARCH_NAME)"
            
            # Find all .so and .dylib files in this artifact directory
            FILES_FOUND=$(find "$artifact_dir" -type f \( -name "*.so" -o -name "*.dylib" \) | wc -l)
            if [ "$FILES_FOUND" -eq 0 ]; then
              echo "  WARNING: No .so or .dylib files found in $artifact_dir"
            fi
            
            find "$artifact_dir" -type f \( -name "*.so" -o -name "*.dylib" \) | while read -r file; do
              # Get file extension
              EXT=$(echo "$file" | sed 's/.*\.//')
              
              # Create descriptive filename using artifact name (most reliable)
              NEW_NAME="opa-php${VERSION}-${ARCH_NAME}.${EXT}"
              
              # Verify the target name is different from source
              SOURCE_NAME=$(basename "$file")
              if [ "$SOURCE_NAME" = "$NEW_NAME" ]; then
                # File already has correct name, just copy it
                cp "$file" "dist/release/${NEW_NAME}"
                echo "  Copied: ${NEW_NAME} (already correctly named)"
              elif [ ! -f "dist/release/${NEW_NAME}" ]; then
                cp "$file" "dist/release/${NEW_NAME}"
                echo "  Copied: ${NEW_NAME} (renamed from ${SOURCE_NAME})"
              else
                echo "  ERROR: Target file already exists: ${NEW_NAME}"
                echo "  Source: $file"
                # Don't overwrite, but log the issue
              fi
            done
          done
          
          # Also check for direct structure (dist/php{version}/{arch}/opa.{so,dylib})
          # This handles cases where artifacts might be structured differently
          for version in 8.3 8.4 8.5; do
            if [ -d "dist/php${version}" ]; then
              echo "Processing direct structure: dist/php${version}/"
              for arch_dir in dist/php${version}/*; do
                if [ -d "$arch_dir" ]; then
                  ARCH_NAME=$(basename "$arch_dir")
                  
                  if [ -f "$arch_dir/opa.so" ]; then
                    NEW_NAME="opa-php${version}-${ARCH_NAME}.so"
                    if [ ! -f "dist/release/${NEW_NAME}" ]; then
                      cp "$arch_dir/opa.so" "dist/release/${NEW_NAME}"
                      echo "  Copied: ${NEW_NAME}"
                    fi
                  fi
                  
                  if [ -f "$arch_dir/opa.dylib" ]; then
                    NEW_NAME="opa-php${version}-${ARCH_NAME}.dylib"
                    if [ ! -f "dist/release/${NEW_NAME}" ]; then
                      cp "$arch_dir/opa.dylib" "dist/release/${NEW_NAME}"
                      echo "  Copied: ${NEW_NAME}"
                    fi
                  fi
                fi
              done
            fi
          done
          
          # Final catch-all: find any remaining .so or .dylib files we might have missed
          echo ""
          echo "=== Checking for any remaining files ==="
          find dist -type f \( -name "*.so" -o -name "*.dylib" \) ! -path "dist/release/*" | while read -r file; do
            # Try to extract info from path
            VERSION=""
            ARCH_NAME=""
            
            # Try to extract from path patterns
            if echo "$file" | grep -q "php8\.[345]"; then
              VERSION=$(echo "$file" | grep -oE 'php(8\.[345])' | sed 's/php//')
              # Try to get arch from parent directory
              PARENT_DIR=$(dirname "$file" | xargs basename)
              if [ "$PARENT_DIR" != "dist" ] && [ "$PARENT_DIR" != "release" ] && [ "$PARENT_DIR" != "modules" ]; then
                ARCH_NAME="$PARENT_DIR"
              fi
            fi
            
            # Try to extract from artifact directory
            if [ -z "$VERSION" ] || [ -z "$ARCH_NAME" ]; then
              ARTIFACT_PATH=$(echo "$file" | sed 's|dist/\([^/]*\).*|\1|')
              if echo "$ARTIFACT_PATH" | grep -q "opa-php"; then
                VERSION=$(echo "$ARTIFACT_PATH" | grep -oE 'php(8\.[345])' | sed 's/php//')
                ARCH_NAME=$(echo "$ARTIFACT_PATH" | sed "s/opa-php${VERSION}-//")
              fi
            fi
            
            if [ -n "$VERSION" ] && [ -n "$ARCH_NAME" ]; then
              EXT=$(echo "$file" | sed 's/.*\.//')
              NEW_NAME="opa-php${VERSION}-${ARCH_NAME}.${EXT}"
              if [ ! -f "dist/release/${NEW_NAME}" ]; then
                cp "$file" "dist/release/${NEW_NAME}"
                echo "  Found and copied: ${NEW_NAME} from $file"
              fi
            else
              echo "  Warning: Could not determine version/arch for $file"
            fi
          done
          
          # Verify files exist
          echo ""
          echo "=== Final release files ==="
          ls -lah dist/release/ || echo "No files found in dist/release/"
          echo ""
          
          # Check if we have at least one file
          FILE_COUNT=$(find dist/release -type f \( -name "*.so" -o -name "*.dylib" \) 2>/dev/null | wc -l)
          if [ "$FILE_COUNT" -eq 0 ]; then
            echo "ERROR: No .so or .dylib files found for release!"
            echo ""
            echo "Debug: Full directory tree:"
            find dist -type f | sort || true
            exit 1
          fi
          echo "✓ Found $FILE_COUNT extension file(s) for release:"
          find dist/release -type f \( -name "*.so" -o -name "*.dylib" \) -exec basename {} \; | sort
          
          # Verify we have files with descriptive names (not just opa.so/opa.dylib)
          GENERIC_COUNT=$(find dist/release -type f \( -name "opa.so" -o -name "opa.dylib" \) 2>/dev/null | wc -l)
          DESCRIPTIVE_COUNT=$(find dist/release -type f \( -name "opa-php*.so" -o -name "opa-php*.dylib" \) 2>/dev/null | wc -l)
          
          if [ "$GENERIC_COUNT" -gt 0 ] && [ "$DESCRIPTIVE_COUNT" -eq 0 ]; then
            echo ""
            echo "WARNING: Only generic files found (opa.so/opa.dylib), no descriptive names!"
            echo "This suggests the reorganization didn't work correctly."
          fi
          
          # Expected: 12 files total (6 Linux + 6 macOS)
          # Linux: 2 architectures (amd64, arm64) × 3 PHP versions (8.3, 8.4, 8.5) = 6 files
          # macOS: 2 architectures (amd64, arm64) × 3 PHP versions (8.3, 8.4, 8.5) = 6 files
          if [ "$DESCRIPTIVE_COUNT" -lt 12 ]; then
            echo ""
            echo "WARNING: Expected 12 files (6 Linux + 6 macOS), found $DESCRIPTIVE_COUNT"
            echo "This may indicate some build jobs failed or artifacts weren't uploaded correctly."
          fi
      
      - name: Extract tag name
        id: tag
        run: |
          # Extract tag name from ref (e.g., refs/tags/v1.2.3 -> v1.2.3)
          TAG_NAME=${GITHUB_REF#refs/tags/}
          echo "tag=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "Creating release for tag: $TAG_NAME"
      
      - name: Create release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.tag.outputs.tag }}
          name: Release ${{ steps.tag.outputs.tag }}
          files: |
            dist/release/*.so
            dist/release/*.dylib
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

