name: SQL Profiling E2E Test

on:
  push:
    branches: [ main, develop, feature/* ]
    paths:
      - '**/*.c'
      - '**/*.h'
      - 'docker/Dockerfile*'
      - 'docker/compose/*.yml'
      - 'tests/e2e/sql/*.sh'
      - '.github/workflows/test-sql-e2e.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - '**/*.c'
      - '**/*.h'
      - 'docker/Dockerfile*'
      - 'docker/compose/*.yml'
      - 'tests/e2e/sql/*.sh'
      - '.github/workflows/test-sql-e2e.yml'
  workflow_dispatch:

jobs:
  test-sql-e2e:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    services:
      clickhouse:
        image: clickhouse/clickhouse-server:23.3
        ports:
          - 9000:9000
          - 8123:8123
        options: >-
          --health-cmd "wget --spider -q http://localhost:8123/ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        env:
          TZ: Europe/Paris
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Create Docker network
        run: docker network create opa_network || true
      
      - name: Checkout parent repository (for agent)
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository_owner }}/myapm
          path: parent-repo
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
        continue-on-error: true
      
      - name: Build agent
        id: build-agent
        working-directory: parent-repo/agent
        run: |
          docker build --no-cache -t myapm-agent .
          docker tag myapm-agent:latest ghcr.io/thegrimmchester/opa-agent:latest
        continue-on-error: true
      
      - name: Use pre-built agent image (if build failed)
        if: steps.build-agent.outcome == 'failure'
        run: |
          echo "Agent build failed, trying to use pre-built image"
          docker pull ghcr.io/thegrimmchester/opa-agent:latest || docker pull ghcr.io/thegrimmchester/opa-agent:main || true
          docker tag ghcr.io/thegrimmchester/opa-agent:latest myapm-agent:latest 2>/dev/null || \
          docker tag ghcr.io/thegrimmchester/opa-agent:main myapm-agent:latest 2>/dev/null || true
      
      - name: Start agent
        run: |
          docker run -d \
            --name opa-agent \
            --network opa_network \
            -e CLICKHOUSE_URL=http://clickhouse:8123 \
            -e TRANSPORT_TCP=:9090 \
            -p 8081:8080 \
            myapm-agent:latest
          sleep 5
          for i in {1..30}; do
            if curl -f http://localhost:8081/api/health > /dev/null 2>&1; then
              echo "Agent is ready"
              break
            fi
            sleep 1
          done
          curl -f http://localhost:8081/api/health || exit 1
      
      - name: Build PHP extension image
        run: |
          docker build --no-cache -f docker/Dockerfile -t php-extension-test .
      
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y curl jq
      
      - name: Run SQL E2E test
        env:
          CI_MODE: 1
          API_URL: http://localhost:8081
          PROJECT_ROOT: ${{ github.workspace }}/..
          MYSQL_HOST: mysql-test
          MYSQL_PORT: 3306
          MYSQL_DATABASE: test_db
          MYSQL_USER: test_user
          MYSQL_PASSWORD: test_password
          MYSQL_ROOT_PASSWORD: root_password
        run: |
          chmod +x tests/e2e/sql/test_sql_ci_e2e.sh
          ./tests/e2e/sql/test_sql_ci_e2e.sh --ci
      
      - name: Cleanup
        if: always()
        run: |
          docker-compose -f docker/compose/docker-compose.test.yml down || true
          docker stop opa-agent || true
          docker rm opa-agent || true
          docker network rm opa_network || true

