name: Error and Log Tracking E2E Test

on:
  push:
    branches: [ main, develop, feature/* ]
    paths:
      - '**/*.c'
      - '**/*.h'
      - 'Dockerfile*'
      - 'docker-compose*.yml'
      - 'test_error_log*.sh'
      - 'tests/error_log*.php'
      - '.github/workflows/test-error-log-e2e.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - '**/*.c'
      - '**/*.h'
      - 'Dockerfile*'
      - 'docker-compose*.yml'
      - 'test_error_log*.sh'
      - 'tests/error_log*.php'
      - '.github/workflows/test-error-log-e2e.yml'
  workflow_dispatch:

jobs:
  test-error-log-e2e:
    name: Error/Log E2E Test (PHP ${{ matrix.php_version }})
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      contents: read
      packages: read
    strategy:
      matrix:
        php_version: ['8.3', '8.4', '8.5']
      fail-fast: false
    
    services:
      clickhouse:
        image: clickhouse/clickhouse-server:23.3
        ports:
          - 9000:9000
          - 8123:8123
        options: >-
          --health-cmd "wget --spider -q http://localhost:8123/ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        env:
          TZ: Europe/Paris
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Create Docker network
        run: docker network create opa_network || true
      
      - name: Pull or build agent image
        id: agent-image
        run: |
          echo "Attempting to pull published agent image from registry"
          if docker pull ghcr.io/thegrimmchester/opa-agent:latest; then
            docker tag ghcr.io/thegrimmchester/opa-agent:latest opa-agent:latest
            echo "Using latest tag from registry"
            echo "image_source=registry" >> $GITHUB_OUTPUT
          elif docker pull ghcr.io/thegrimmchester/opa-agent:main; then
            docker tag ghcr.io/thegrimmchester/opa-agent:main opa-agent:latest
            echo "Using main tag from registry"
            echo "image_source=registry" >> $GITHUB_OUTPUT
          elif docker pull ghcr.io/thegrimmchester/opa-agent:sha-$(echo ${{ github.sha }} | cut -c1-7); then
            docker tag ghcr.io/thegrimmchester/opa-agent:sha-$(echo ${{ github.sha }} | cut -c1-7) opa-agent:latest
            echo "Using SHA tag from registry"
            echo "image_source=registry" >> $GITHUB_OUTPUT
          else
            echo "Published images not found, building from agent repository"
            git clone --depth 1 https://github.com/TheGrimmChester/OPA-Agent.git agent-repo || exit 1
            cd agent-repo
            if [ ! -f Dockerfile ]; then
              echo "ERROR: Dockerfile not found in agent repository"
              exit 1
            fi
            docker build --no-cache -t opa-agent:latest .
            echo "Built agent image from repository"
            echo "image_source=build" >> $GITHUB_OUTPUT
          fi
      
      - name: Verify agent image exists
        run: |
          if ! docker images opa-agent:latest --format "{{.Repository}}:{{.Tag}}" | grep -q "opa-agent:latest"; then
            echo "ERROR: Agent image opa-agent:latest does not exist"
            docker images
            exit 1
          fi
          echo "Agent image verified:"
          docker images opa-agent:latest
      
      - name: Start agent
        run: |
          # Use 172.17.0.1 (Docker bridge gateway) to access ClickHouse service via host
          # GitHub Actions services expose ports to localhost, and 172.17.0.1 is the default bridge gateway
          # This is more reliable than host.docker.internal in GitHub Actions environment
          echo "Starting agent with ClickHouse URL: http://172.17.0.1:8123"
          docker run -d \
            --name opa-agent \
            --network opa_network \
            --add-host host.docker.internal:host-gateway \
            -e CLICKHOUSE_URL=http://172.17.0.1:8123 \
            -e TRANSPORT_TCP=:9090 \
            -p 8081:8080 \
            -p 9090:9090 \
            opa-agent:latest
          sleep 5
          for i in {1..30}; do
            if curl -f http://localhost:8081/api/health > /dev/null 2>&1; then
              echo "Agent is ready"
              break
            fi
            echo "Waiting for agent... ($i/30)"
            sleep 1
          done
          curl -f http://localhost:8081/api/health || exit 1
          
          # Check agent logs for ClickHouse connection issues
          echo "Agent logs (last 50 lines):"
          docker logs opa-agent --tail 50 || true
          
          # Test if agent can reach ClickHouse
          echo "Testing ClickHouse connectivity from agent container..."
          docker exec opa-agent wget --spider -q http://172.17.0.1:8123/ping && echo "ClickHouse is reachable from agent" || echo "WARNING: ClickHouse may not be reachable from agent"
      
      - name: Build PHP extension image
        run: |
          echo "Building PHP extension for PHP ${{ matrix.php_version }}"
          docker build --no-cache --build-arg PHP_VERSION=${{ matrix.php_version }} -t php-extension-test .
      
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y curl jq
      
      - name: Run Error/Log E2E test
        env:
          CI_MODE: 1
          API_URL: http://localhost:8081
          PROJECT_ROOT: ${{ github.workspace }}/..
          CLICKHOUSE_HOST: clickhouse
          CLICKHOUSE_PORT: 9000
          CLICKHOUSE_HTTP_PORT: 8123
        run: |
          chmod +x test_error_log_ci_e2e.sh
          ./test_error_log_ci_e2e.sh --ci
      
      - name: Cleanup
        if: always()
        run: |
          docker compose -f docker-compose.test.yml down || true
          docker stop opa-agent || true
          docker rm opa-agent || true
          docker network rm opa_network || true
