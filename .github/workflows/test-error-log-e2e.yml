name: Error and Log Tracking E2E Test

on:
  push:
    branches: [ main, develop, feature/* ]
    paths:
      - '**/*.c'
      - '**/*.h'
      - 'docker/Dockerfile*'
      - 'docker/compose/*.yml'
      - 'tests/e2e/errors/*.sh'
      - 'tests/e2e/errors/*.php'
      - '.github/workflows/test-error-log-e2e.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - '**/*.c'
      - '**/*.h'
      - 'docker/Dockerfile*'
      - 'docker/compose/*.yml'
      - 'tests/e2e/errors/*.sh'
      - 'tests/e2e/errors/*.php'
      - '.github/workflows/test-error-log-e2e.yml'
  workflow_dispatch:

jobs:
  test-error-log-e2e:
    name: Error/Log E2E Test (PHP ${{ matrix.php_version }})
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      contents: read
      packages: read
    strategy:
      matrix:
        php_version: ['8.3', '8.4', '8.5']
      fail-fast: false
    
    services:
      clickhouse:
        image: clickhouse/clickhouse-server:23.3
        ports:
          - 9000:9000
          - 8123:8123
        options: >-
          --health-cmd "wget --spider -q http://localhost:8123/ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        env:
          TZ: Europe/Paris
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Set up Docker Compose
        run: |
          echo "Verifying Docker Compose availability..."
          if docker compose version >/dev/null 2>&1; then
            echo "Docker Compose v2 is available"
            docker compose version
          elif docker-compose version >/dev/null 2>&1; then
            echo "Docker Compose v1 is available"
            docker-compose version
          else
            echo "ERROR: Neither 'docker compose' nor 'docker-compose' is available"
            exit 1
          fi
      
      - name: Verify ClickHouse service is accessible
        run: |
          echo "Waiting for ClickHouse service to be ready..."
          max_attempts=30
          attempt=0
          while [ $attempt -lt $max_attempts ]; do
            if curl -sf http://localhost:8123/ping > /dev/null 2>&1; then
              echo "ClickHouse service is accessible on localhost:8123"
              curl -sf http://localhost:8123/ping
              break
            fi
            echo "Waiting for ClickHouse... ($attempt/$max_attempts)"
            sleep 1
            attempt=$((attempt + 1))
          done
          if [ $attempt -eq $max_attempts ]; then
            echo "ERROR: ClickHouse service is not accessible after $max_attempts attempts"
            exit 1
          fi
      
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Create Docker network
        run: |
          echo "Creating Docker network opa_network..."
          docker network create opa_network || true
          echo "Verifying network exists..."
          docker network inspect opa_network || (echo "ERROR: Network opa_network was not created" && exit 1)
          echo "Network opa_network is ready"
      
      - name: Pull or build agent image
        id: agent-image
        run: |
          echo "Attempting to pull published agent image from registry"
          if docker pull ghcr.io/thegrimmchester/opa-agent:latest; then
            docker tag ghcr.io/thegrimmchester/opa-agent:latest opa-agent:latest
            echo "Using latest tag from registry"
            echo "image_source=registry" >> $GITHUB_OUTPUT
          elif docker pull ghcr.io/thegrimmchester/opa-agent:main; then
            docker tag ghcr.io/thegrimmchester/opa-agent:main opa-agent:latest
            echo "Using main tag from registry"
            echo "image_source=registry" >> $GITHUB_OUTPUT
          elif docker pull ghcr.io/thegrimmchester/opa-agent:sha-$(echo ${{ github.sha }} | cut -c1-7); then
            docker tag ghcr.io/thegrimmchester/opa-agent:sha-$(echo ${{ github.sha }} | cut -c1-7) opa-agent:latest
            echo "Using SHA tag from registry"
            echo "image_source=registry" >> $GITHUB_OUTPUT
          else
            echo "Published images not found, building from agent repository"
            git clone --depth 1 https://github.com/TheGrimmChester/OPA-Agent.git agent-repo || exit 1
            cd agent-repo
            if [ ! -f docker/Dockerfile ]; then
              echo "ERROR: Dockerfile not found in agent repository"
              exit 1
            fi
            docker build --no-cache -t opa-agent:latest .
            echo "Built agent image from repository"
            echo "image_source=build" >> $GITHUB_OUTPUT
          fi
      
      - name: Verify agent image exists
        run: |
          if ! docker images opa-agent:latest --format "{{.Repository}}:{{.Tag}}" | grep -q "opa-agent:latest"; then
            echo "ERROR: Agent image opa-agent:latest does not exist"
            docker images
            exit 1
          fi
          echo "Agent image verified:"
          docker images opa-agent:latest
      
      - name: Verify ClickHouse connectivity from host
        run: |
          echo "Testing ClickHouse connectivity from host..."
          # Test both localhost and bridge gateway
          if curl -sf http://localhost:8123/ping > /dev/null 2>&1; then
            echo "✓ ClickHouse is accessible on localhost:8123"
          else
            echo "✗ ClickHouse is NOT accessible on localhost:8123"
            exit 1
          fi
          
          # Test bridge gateway (what containers will use)
          if curl -sf http://172.17.0.1:8123/ping > /dev/null 2>&1; then
            echo "✓ ClickHouse is accessible on 172.17.0.1:8123 (bridge gateway)"
          else
            echo "⚠ ClickHouse may not be accessible on 172.17.0.1:8123 (this is expected in some CI environments)"
          fi
      
      - name: Start agent
        run: |
          # Use 172.17.0.1 (Docker bridge gateway) to access ClickHouse service via host
          # GitHub Actions services expose ports to localhost, and 172.17.0.1 is the default bridge gateway
          # This is more reliable than host.docker.internal in GitHub Actions environment
          echo "Starting agent with configuration:"
          echo "  - CLICKHOUSE_URL=http://172.17.0.1:8123"
          echo "  - TRANSPORT_TCP=:9090"
          echo "  - Network: opa_network"
          docker run -d \
            --name opa-agent \
            --network opa_network \
            --add-host host.docker.internal:host-gateway \
            -e CLICKHOUSE_URL=http://172.17.0.1:8123 \
            -e TRANSPORT_TCP=:9090 \
            -p 8081:8080 \
            -p 9090:9090 \
            opa-agent:latest
          
          echo "Waiting for agent to start..."
          sleep 5
          
          # Wait for agent health check
          max_attempts=30
          attempt=0
          while [ $attempt -lt $max_attempts ]; do
            if curl -f http://localhost:8081/api/health > /dev/null 2>&1; then
              echo "✓ Agent is ready and healthy"
              curl -sf http://localhost:8081/api/health | head -20 || true
              break
            fi
            echo "Waiting for agent... ($attempt/$max_attempts)"
            sleep 1
            attempt=$((attempt + 1))
          done
          
          if [ $attempt -eq $max_attempts ]; then
            echo "ERROR: Agent did not become ready after $max_attempts attempts"
            echo "Agent logs (last 50 lines):"
            docker logs opa-agent --tail 50 || true
            exit 1
          fi
          
          # Check agent logs for ClickHouse connection issues
          echo "Agent logs (last 50 lines):"
          docker logs opa-agent --tail 50 || true
          
          # Test if agent can reach ClickHouse
          echo "Testing ClickHouse connectivity from agent container..."
          if docker exec opa-agent wget --spider -q http://172.17.0.1:8123/ping 2>&1; then
            echo "✓ ClickHouse is reachable from agent container via 172.17.0.1:8123"
          else
            echo "⚠ WARNING: ClickHouse may not be reachable from agent container"
            echo "Attempting alternative connection test..."
            docker exec opa-agent wget --spider -q http://host.docker.internal:8123/ping 2>&1 && echo "✓ ClickHouse is reachable via host.docker.internal" || echo "✗ ClickHouse is not reachable via host.docker.internal"
          fi
      
      - name: Verify agent configuration
        run: |
          echo "Verifying agent configuration..."
          echo "Agent container network:"
          docker inspect opa-agent --format '{{range .NetworkSettings.Networks}}{{.NetworkID}} {{end}}' || true
          
          echo "Agent environment variables:"
          docker exec opa-agent env | grep -E "(CLICKHOUSE|TRANSPORT)" || true
          
          echo "Agent can reach opa-agent hostname:"
          docker exec opa-agent getent hosts opa-agent || echo "⚠ opa-agent hostname not resolvable (this may be expected)"
      
      - name: Verify agent connection from network
        run: |
          echo "Verifying agent connection from Docker network..."
          
          # Check if agent port 9090 is listening
          echo "Checking if agent is listening on port 9090..."
          if docker exec opa-agent netstat -tuln 2>/dev/null | grep -q ":9090" || docker exec opa-agent ss -tuln 2>/dev/null | grep -q ":9090"; then
            echo "✓ Agent is listening on port 9090"
          else
            echo "⚠ Could not verify agent is listening on port 9090 (netstat/ss may not be available)"
          fi
          
          # Test connection from a temporary container on the same network
          echo "Testing TCP connection to agent from network container..."
          if docker run --rm --network opa_network \
            alpine:latest \
            sh -c "apk add --no-cache bash >/dev/null 2>&1 && timeout 3 bash -c 'echo > /dev/tcp/opa-agent/9090' 2>/dev/null && echo 'Connection successful'" 2>&1 | grep -q "Connection successful"; then
            echo "✓ Agent TCP port 9090 is accessible from network containers"
          else
            echo "⚠ Direct TCP test completed (testing with netcat instead)"
          fi
          
          # Alternative test using telnet or nc if available
          echo "Testing agent connection with alternative method..."
          docker run --rm --network opa_network \
            alpine:latest \
            sh -c "apk add --no-cache netcat-openbsd >/dev/null 2>&1 && nc -zv opa-agent 9090 2>&1 || echo 'Connection test attempted'" || true
          
          # Verify agent hostname resolution
          echo "Verifying agent hostname resolution from network..."
          docker run --rm --network opa_network \
            alpine:latest \
            getent hosts opa-agent && echo "✓ opa-agent hostname resolves correctly" || echo "✗ opa-agent hostname does not resolve"
          
          # Check agent API endpoint
          echo "Verifying agent API endpoint..."
          if curl -sf http://localhost:8081/api/health > /dev/null 2>&1; then
            echo "✓ Agent API is accessible on localhost:8081"
            echo "Agent health response:"
            curl -sf http://localhost:8081/api/health | head -5 || true
          else
            echo "✗ Agent API is not accessible on localhost:8081"
            exit 1
          fi
          
          # Verify agent can receive traces (check if it's processing)
          echo "Checking agent trace processing capability..."
          agent_status=$(curl -sf http://localhost:8081/api/health 2>/dev/null || echo "")
          if [ -n "$agent_status" ]; then
            echo "✓ Agent is healthy and ready to receive connections"
          else
            echo "✗ Agent health check failed"
            exit 1
          fi
      
      - name: Build PHP extension image
        run: |
          echo "Building PHP extension for PHP ${{ matrix.php_version }}"
          docker build --no-cache --build-arg PHP_VERSION=${{ matrix.php_version }} -f docker/Dockerfile -t php-extension-test .
      
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y curl jq
      
      - name: Verify test configuration
        run: |
          echo "Verifying test configuration..."
          echo "PHP INI settings that will be used:"
          echo "  - opa.socket_path=opa-agent:9090"
          echo "  - opa.enabled=1"
          echo "  - opa.sampling_rate=1.0"
          echo "  - opa.collect_internal_functions=1"
          echo "  - opa.debug_log=0"
          echo "  - opa.service=error-log-ci-test"
          echo "  - opa.track_errors=1"
          echo "  - opa.track_logs=1"
          echo "  - opa.log_levels=critical,error,warning"
          echo ""
          echo "Environment variables:"
          echo "  - CI_MODE=1"
          echo "  - API_URL=http://localhost:8081"
          echo "  - PROJECT_ROOT=${{ github.workspace }}/.."
          echo "  - CLICKHOUSE_PORT=9000"
          echo "  - CLICKHOUSE_HTTP_PORT=8123"
          echo "  (CLICKHOUSE_HOST auto-detected from service container)"
          echo ""
          echo "Verifying agent is accessible from host:"
          curl -sf http://localhost:8081/api/health > /dev/null && echo "✓ Agent API is accessible" || (echo "✗ Agent API is not accessible" && exit 1)
          echo ""
          echo "Verifying PHP extension image exists:"
          docker images php-extension-test --format "{{.Repository}}:{{.Tag}}" | head -1 || (echo "✗ PHP extension image not found" && exit 1)
          echo "✓ PHP extension image exists"
          echo ""
          echo "Verifying network connectivity:"
          docker network inspect opa_network --format '{{range .Containers}}{{.Name}} {{end}}' | grep -q opa-agent && echo "✓ Agent is on opa_network" || echo "⚠ Agent may not be on opa_network"
      
      - name: Run Error/Log E2E test
        env:
          CI_MODE: 1
          API_URL: http://localhost:8081
          PROJECT_ROOT: ${{ github.workspace }}/..
          CLICKHOUSE_PORT: 9000
          CLICKHOUSE_HTTP_PORT: 8123
        run: |
          chmod +x tests/e2e/errors/test_error_log_ci_e2e.sh
          ./tests/e2e/errors/test_error_log_ci_e2e.sh --ci
      
      - name: Cleanup
        if: always()
        run: |
          docker compose -f docker/compose/docker-compose.test.yml down || true
          docker stop opa-agent || true
          docker rm opa-agent || true
          docker network rm opa_network || true
